stages:
  - build
  - test 
  - push

variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2
  IMAGE_NAME: testy
  IMAGE_TAR: $IMAGE_NAME.tar

build_image:
  image: docker:24.0.2
  services:
    - docker:24.0.2-dind
  stage: build
  script:
    - docker info
    - docker build -t $IMAGE_NAME:latest .
    - docker save $IMAGE_NAME:latest -o $IMAGE_TAR
  artifacts:
    paths:
      - $IMAGE_TAR
    expire_in: 1 day  # Optional: auto-clean after 24 hours

#test_image:
#     image: docker:24.0.2
#      services:
#        - docker:24.0.2-dind
#      stage: test
#      dependencies:
#        - build_image
#      script:
#        - docker load -i $IMAGE_TAR
#       - docker run --rm --entrypoint cat $IMAGE_NAME:latest /app/wizexercise.txt

push_image:
  image: docker:24.0.2
  services:
    - docker:24.0.2-dind
  stage: push
  dependencies:
    - build_image
  script:
    - docker load -i $IMAGE_TAR
    - docker tag $IMAGE_NAME:latest $DOCKERHUB_USERNAME/$IMAGE_NAME:latest
    - echo "$DOCKERHUB_ACCESS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKERHUB_USERNAME/$IMAGE_NAME:latest